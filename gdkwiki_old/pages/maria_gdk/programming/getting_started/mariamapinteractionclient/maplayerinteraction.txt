 =====  Map Layer =====

<wrap info>This section is depending on steps performed in [[maria_gdk:programming:getting_started:mariamapinteractionclient:basicinteraction|Basic Interaction]] </wrap>
====  Maria navigation control management ====

//MariaUserControl// contains built-in navigation controls and navigation commands.

To enable/disable navigation controls, add four check boxes (Ruler, Pan Navigation, Scale Bar and Mini Map) -- and bind them to the //MariaUserControl.//

<code xml>
<CheckBox Content="Ruler" ToolTip="Ruler" 
              Name="IsRulerVisible" 
              IsChecked="{Binding IsRulerVisible, ElementName=MariaCtrl}" />
<CheckBox Content="Pan Navigation" ToolTip="Pan Navigation" 
              Name="IsPanNavigationVisible" 
              IsChecked="{Binding IsPanNavigationVisible, ElementName=MariaCtrl}" />
<CheckBox Content="Scale Bar" ToolTip="Scale Bar" 
              Name="IsScaleBarVisible" 
              IsChecked="{Binding IsScaleBarVisible, ElementName=MariaCtrl}" />
<CheckBox Content="Mini Map" ToolTip="Mini Map" 
              Name="IsMiniMapVisible1" 
              IsChecked="{Binding IsMiniMapVisible, ElementName=MariaCtrl}" />
</code>

<WRAP center round box>
You should now be able to toggle the display of the navigation tools.
</WRAP>

{{maria_gdk:programming:maria_2012_tutorial_html_51de52c4.png|Manage built in navigation controls}}\\ Figure : Manage built in navigation controls

====  Navigating the map ====

To access the navigation commands directly, add four pushbuttons (Pan Left, Pan Right, Pan Up, Pan Down) to your main window (wrap panel) -- and bind them to the //MariaUserControl.//

<code xml>
<Button Content="Pan Left" ToolTip="Pan Left" 
        Name="PanLeftCommand" 
        Command="{Binding PanLeftCommand, ElementName=MariaCtrl}" />
<Button Content="PanRight" ToolTip="PanRight" 
        Name="PanRightCommand" 
        Command="{Binding PanRightCommand, ElementName=MariaCtrl}" />
<Button Content="PanUp" ToolTip="PanUp" 
        Name="PanUpCommand" 
        Command="{Binding PanUpCommand, ElementName=MariaCtrl}" />
<Button Content="PanDown" ToolTip="PanDown" 
        Name="PanDownCommand"
        Command="{Binding PanDownCommand, ElementName=MariaCtrl}" />
</code>

Add the following navigation properties to your map interface class (//MapViewModel//)

<code csharp>
public ICommand NavigateBackwardCommand
{
    get { return _mapLayer.NavigateBackwardCommand; }
}
public ICommand NavigateForwardCommand
{
    get { return _mapLayer.NavigateForwardCommand; }
}
</code>

Then, add pushbuttons (Navigate Backward and Navigate Forward) for stepping between the previous views.

<code xml>
<Button Content="Navigate Backward" ToolTip="Navigate Backward" 
        Name="NavigateBackwardCommand" 
        Command="{Binding MapViewModel.NavigateBackwardCommand}" />
<Button Content="Navigate Forward" ToolTip="Navigate Forward" 
        Name="NavigateForwardCommand"                     
        Command="{Binding MapViewModel.NavigateForwardCommand}" />
</code>

<WRAP center round box>
You should now be able to navigate the map by selecting your own buttons.
</WRAP>


{{maria_gdk:programming:maria_2012_tutorial_html_m40f04292.png|Map area navigation}}\\ Figure : Map area navigation

<WRAP center round important>
Observe that the forward/backward navigation buttons are disabled until you have panned or zoomed to have views to go to.
</WRAP>

==== Changing map source ====

When several map templates are available, you can include selection of map to use by adding the following properties to //MapViewModel//

<code csharp>
public ReadOnlyObservableCollection<string> ActiveMapNames
{
    get { return _mapLayer.ActiveMapNames; }
}
public string ActiveMapName
{
    get { return _mapLayer.ActiveMapName; }
    set
    {
        _mapLayer.ActiveMapName = value;
        MiniMapLayer.ActiveMapName = value;
        
        NotifyPropertyChanged(() => ActiveMapName);
    }
}
</code>

Then add a combo box to your main window

<code xml>
 <ComboBox Name="cmbActiveMap" 
           ItemsSource="{Binding MapViewModel.ActiveMapNames}" 
           SelectedItem="{Binding MapViewModel.ActiveMapName}"
           IsSynchronizedWithCurrentItem="true"
           Width="Auto" />
</code>


<WRAP center round box>
You should now be able to switch between available map templates.
</WRAP>


{{maria_gdk:programming:maria_2012_tutorial_html_m50a94029.png|Map area navigation}}\\ Figure: Map area navigation.


<WRAP center round important>
Please note that the map templates above are displayed in different scales.
</WRAP>

====  Selecting map sub layers ====

The map templates may be defined with several sub-layers, e.g. the map information itself, and additional elevation shading.

You can control the sub layer display through the map layer, //**IMariaMapLayer.MapDataLayers**// property.

To select sub-layers to be displayed, first add a sub layers property to your view model:

<code csharp>
public ObservableCollection<IRasterLayerData> MapSubLayersDisplay
{
    get { return new ObservableCollection<IRasterLayerData>(_mapLayer.MapDataLayers); }
}
</code>

Then, add a list box with check items your XAML:
<code xml>
<ListBox Name="lstSubLayers" Height="Auto" Margin="2" MinWidth="40"
         ItemsSource="{Binding MapViewModel.MapSubLayersDisplay}" >
    <ListBox.ItemTemplate>
        <DataTemplate>
            <CheckBox Width="Auto" 
                      Content="{Binding Path=Name}" 
                      IsChecked="{Binding Path=Visible, Mode=TwoWay}" />
        </DataTemplate>
    </ListBox.ItemTemplate>
</ListBox>
</code>

To ensure that the sub layer display is updated when a new map source is selected, add the following line to the active map name setter:

<code csharp>
public string ActiveMapName
{
    . . .
    set
    {
        . . .
        NotifyPropertyChanged(() => MapSubLayersDisplay);
    }
}
</code>

<WRAP center round box>
You should now be able to select between different sub layers in your map templates.
</WRAP>

{{maria_gdk:programming::maria_2012_tutorial_html_m42c3ca05.png?664x313|Selecting map sub layers}}\\ Figure: Selecting map sub layers.

====  Adding Web Maps ====

For this part you will need to add the //**TPG.GeoFramemwork.WebMaps.WrapperClient**// package.

You also need to have a Web-Map Service running, available through your Catalog service.

Add the following code to your Map View Model (MapViewModel.cs):

<code csharp>
public MapViewModel(IMariaMapLayer mapLayer)
{
    . . .
    var webMapsClientFactory = new WebMapsClientFactory();
    var webMapsClientManager = new WebMapsClientManager(mapLayer.MapServiceManager, mapLayer.MapResources);

    var os = webMapsClientFactory.CreateOpenStreetClient("Open Street");
    webMapsClientManager.AddClient(os);
    os.Update();
    
    var ve = webMapsClientFactory.CreateVirtualEarthClient("Virtual Earth");
    webMapsClientManager.AddClient(ve);
    ve.Update();
}
</code>

Set ActiveMapName = "No Template" in OnMapLayerInitialized.


<WRAP center round box>
“Virtual Earth” and “Open Street” sub-layers should now be available for all map templates -- including no template.
</WRAP>

{{maria_gdk:programming:::maria_2012_tutorial_html_66df1aaa.png|Web Map Layers}}\\ Figure: Web Map Layers.

====  Bookmarks ====

Bookmarks are shortcuts to specific map sections, specified by map scale and center position. Predefined may be available from the map service for selected map sources. Available bookmarks are listed in the map layer //**Bookmarks**// property, and activated by setting the //**ActiveBookmark**// property.

In the MapLayerViewModel, create properties for bookmark interaction:

<code csharp>
public Bookmark ActiveBookmark { set { _mapLayer.ActiveBookmark = value; } }
public ObservableCollection<Bookmark> Bookmarks { get { return _mapLayer.Bookmarks ; } }
</code>

Then, add a list box with bookmark items for display and selection of bookmarks:
<code xml>
<ListBox Name="lstBookmarks" Height="Auto" Margin="2" 
     ItemsSource="{Binding MapViewModel.Bookmarks}" 
     SelectedItem="{Binding MapViewModel.ActiveBookmark, Mode=OneWayToSource}">
    <ListBox.ItemTemplate>
        <DataTemplate>
            <Label Width="Auto" 
               Content="{Binding Path=Name}" />
        </DataTemplate>
    </ListBox.ItemTemplate>
</ListBox>
</code>

<WRAP center round box >
You should now be able to display different map sections by selecting different bookmarks.
</WRAP>

{{maria_gdk:programming:::maria_2012_tutorial_html_m7b5de762.png|Bookmark navigation}}\\ Figure: Bookmark navigation.

<WRAP center round important>
Note that different map sources may have different bookmarks.
</WRAP>


{{maria_gdk:programming:::maria_2012_tutorial_html_m3a8a3dae.png|Bookmarks for different map sources}}\\ Figure: Bookmarks for different map sources.

Bookmarks can be added or removed //locally// for the map client in runtime.

Add buttons for adding and removing bookmarks to your main window xaml:

<code xml>
<Button Content="Create" Command="{Binding MapViewModel.AddBookmark}"/>
<Button Content="Remove" Command="{Binding MapViewModel.RemoveBookmark}" />
</code>

Implement the command handlers in the view model:

<code csharp>
public ICommand RemoveBookmark { get { return new DelegateCommand(x => OnRemoveBookmark()); } }
private void OnRemoveBookmark()
{
    _mapLayer.Bookmarks.Remove(_mapLayer.ActiveBookmark);
}

public ICommand AddBookmark { get { return new DelegateCommand(x => OnAddBookmark()); } }
private void OnAddBookmark()
{
    _mapLayer.Bookmarks.Add(new Bookmark
                {
                    Name = "Bookmark-" + _cnt++,
                    Pos = new Tuple<double, double>(CenterPosition.Lat, CenterPosition.Lon),
                    Scale = CenterScale,
                    MapSig = ActiveMapName
                });
}   
</code>

<WRAP center round box>
You should now be able to add and remove bookmarks!
</WRAP>

{{maria_gdk:programming:::maria_2012_tutorial_html_m211bd094.png|Adding and removing bookmarks}}\\ Figure: Adding and removing bookmarks.
